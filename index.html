<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M√©t√©o ‚Äì Mini app</title>
  <style>
    :root{
      --glass: rgba(255,255,255,.14);
      --stroke: rgba(255,255,255,.22);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.75);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      overflow:hidden;
      background:#0b1220;
    }

    .bg{
      position:fixed; inset:0;
      background: radial-gradient(1000px 600px at 20% 10%, rgba(255,255,255,.12), transparent 60%),
                  radial-gradient(900px 600px at 80% 40%, rgba(255,255,255,.10), transparent 60%),
                  linear-gradient(180deg, #0b1220, #070a12);
      transition: filter .35s ease, background .35s ease;
    }

    body[data-theme="clear"] .bg{
      background: radial-gradient(900px 600px at 25% 20%, rgba(255,220,120,.35), transparent 60%),
                  radial-gradient(900px 650px at 80% 40%, rgba(120,200,255,.18), transparent 60%),
                  linear-gradient(180deg, #1a2a4a, #0b1220);
    }
    body[data-theme="clouds"] .bg{
      background: radial-gradient(900px 600px at 30% 15%, rgba(220,235,255,.18), transparent 60%),
                  radial-gradient(900px 650px at 85% 45%, rgba(200,200,220,.12), transparent 60%),
                  linear-gradient(180deg, #1b2437, #0b1220);
      filter:saturate(.9);
    }
    body[data-theme="rain"] .bg{
      background: radial-gradient(900px 600px at 30% 15%, rgba(120,170,255,.18), transparent 60%),
                  radial-gradient(900px 650px at 80% 45%, rgba(60,90,160,.16), transparent 60%),
                  linear-gradient(180deg, #121c33, #070a12);
      filter:saturate(.85) contrast(1.05);
    }
    body[data-theme="snow"] .bg{
      background: radial-gradient(900px 600px at 30% 10%, rgba(240,250,255,.25), transparent 60%),
                  radial-gradient(900px 650px at 80% 45%, rgba(210,240,255,.14), transparent 60%),
                  linear-gradient(180deg, #13223a, #070a12);
      filter:saturate(.95);
    }
    body[data-theme="storm"] .bg{
      background: radial-gradient(900px 600px at 30% 15%, rgba(160,170,255,.16), transparent 60%),
                  radial-gradient(900px 650px at 80% 45%, rgba(70,70,120,.14), transparent 60%),
                  linear-gradient(180deg, #0e1427, #05060b);
      filter: contrast(1.1) saturate(.85);
    }

    .fx{ position:fixed; inset:0; pointer-events:none; }
    .hidden{ display:none; }

    .clouds{ opacity:.85; }
    .cloud{
      position:absolute;
      top:12%;
      width:320px; height:110px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      filter: blur(.2px);
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      animation: drift linear infinite;
    }
    .cloud:before, .cloud:after{
      content:"";
      position:absolute;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
    }
    .cloud:before{ width:150px; height:90px; left:35px; top:-40px;}
    .cloud:after{ width:190px; height:100px; left:130px; top:-55px;}
    @keyframes drift{
      from{ transform: translateX(-420px); }
      to{ transform: translateX(calc(100vw + 420px)); }
    }

    .rain{ opacity:.9; }
    .drop{
      position:absolute; top:-20px;
      width:2px; height:18px;
      background: linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,.55));
      animation: fall linear infinite;
    }
    @keyframes fall{
      to{ transform: translateY(calc(100vh + 40px)); }
    }

    .snow{ opacity:.95; }
    .flake{
      position:absolute; top:-20px;
      width:6px; height:6px;
      border-radius:50%;
      background: rgba(255,255,255,.75);
      box-shadow: 0 0 16px rgba(255,255,255,.35);
      animation: snowFall linear infinite;
    }
    @keyframes snowFall{
      to{ transform: translateY(calc(100vh + 40px)); }
    }

    .lightning{
      position:absolute; inset:0;
      opacity:0;
      background: radial-gradient(1200px 600px at 60% 25%, rgba(255,255,255,.18), transparent 60%),
                  linear-gradient(180deg, rgba(255,255,255,.12), transparent 40%);
      animation: flash 6.2s infinite;
    }
    @keyframes flash{
      0%, 88%, 100% { opacity:0; }
      90% { opacity:.55; }
      91% { opacity:0; }
      92% { opacity:.42; }
      93% { opacity:0; }
    }

    .sun{
      position:absolute; right:8%; top:10%;
      width:140px; height:140px;
      border-radius:50%;
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.9), rgba(255,220,120,.95) 35%, rgba(255,160,70,.55) 70%, rgba(255,160,70,0) 72%);
      filter: blur(.2px);
      box-shadow: 0 0 90px rgba(255,210,120,.25);
      animation: pulse 3.2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); }
      50%{ transform: scale(1.04); }
    }

    .app{
      position:relative;
      width:min(920px, 94vw);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
      padding:18px;
      z-index:2;
    }
    @media (max-width: 820px){
      .app{ grid-template-columns: 1fr; }
    }
    .card{
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .card .inner{ padding:18px; }

    .topbar{
      display:flex; gap:12px; align-items:center;
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.14);
    }
    .brand{
      font-weight:700;
      letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(255,255,255,.8);
      box-shadow: 0 0 18px rgba(255,255,255,.35);
    }
    .search{
      flex:1;
      display:flex; gap:10px;
    }
    input{
      flex:1;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.15);
      color:var(--text);
      border-radius: 14px;
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color:rgba(255,255,255,.55); }
    button{
      border:1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.14);
      color: var(--text);
      border-radius: 14px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:600;
      transition: transform .08s ease, background .2s ease;
      white-space:nowrap;
    }
    button:hover{ background: rgba(255,255,255,.18); }
    button:active{ transform: scale(.98); }

    .main{ display:grid; gap:14px; }
    .hero{
      display:flex; justify-content:space-between; gap:14px; align-items:flex-start;
    }
    .city{ font-size:24px; font-weight:800; line-height:1.1; }
    .meta{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .temp{ font-size:54px; font-weight:900; letter-spacing:-1px; }
    .desc{ margin-top:2px; color:var(--muted); text-transform: capitalize; }
    .chips{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .chip{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.12);
      border-radius: 999px;
      padding:8px 10px;
      font-size:13px;
      color: rgba(255,255,255,.82);
    }

    .side .row{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 0;
      border-bottom:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.86);
    }
    .side .row:last-child{ border-bottom:0; }
    .label{ color:var(--muted); font-size:13px; }
    .value{ font-weight:700; }

    .status{
      margin-top:10px;
      font-size:13px;
      color: rgba(255,255,255,.85);
    }
    .error{ color: rgba(255,170,170,.95); }
    .hint{
      margin-top:12px;
      font-size:12px;
      color: rgba(255,255,255,.65);
    }
  </style>
</head>

<body data-theme="clouds">
  <div class="bg"></div>

  <!-- FX layers -->
  <div class="fx clouds hidden" id="fxClouds">
    <div class="cloud" style="top:14%; animation-duration:36s; opacity:.95;"></div>
    <div class="cloud" style="top:24%; animation-duration:46s; opacity:.75; width:380px;"></div>
    <div class="cloud" style="top:38%; animation-duration:54s; opacity:.6; width:420px;"></div>
  </div>
  <div class="fx rain hidden" id="fxRain"></div>
  <div class="fx snow hidden" id="fxSnow"></div>
  <div class="fx storm hidden" id="fxStorm"><div class="lightning"></div></div>
  <div class="fx clear hidden" id="fxSun"><div class="sun"></div></div>

  <div class="app">
    <div class="card">
      <div class="topbar">
        <div class="brand"><span class="dot"></span> M√©t√©o</div>
        <div class="search">
          <input id="cityInput" placeholder="Ex: Paris, Montr√©al, Qu√©bec‚Ä¶" autocomplete="off" />
          <button id="searchBtn">Rechercher</button>
          <button id="geoBtn" title="Utiliser ma position">üìç</button>
        </div>
      </div>

      <div class="inner main">
        <div class="hero">
          <div>
            <div class="city" id="cityName">‚Äî</div>
            <div class="meta">
              <div id="timeLocal">‚Äî</div>
              <div>‚Ä¢</div>
              <div id="country">‚Äî</div>
            </div>
            <div class="desc" id="desc">‚Äî</div>
            <div class="chips" id="chips"></div>
          </div>
          <div style="text-align:right">
            <div class="temp" id="temp">--¬∞</div>
            <div class="label" id="feels">Ressenti ‚Äî</div>
          </div>
        </div>

        <div class="status" id="status"></div>
        <div class="hint">Tu peux chercher une ville, ou cliquer sur üìç.</div>
      </div>
    </div>

    <div class="card side">
      <div class="inner">
        <div class="row"><div class="label">Humidit√©</div><div class="value" id="humidity">‚Äî</div></div>
        <div class="row"><div class="label">Vent</div><div class="value" id="wind">‚Äî</div></div>
        <div class="row"><div class="label">Pression</div><div class="value" id="pressure">‚Äî</div></div>
        <div class="row"><div class="label">Visibilit√©</div><div class="value" id="visibility">‚Äî</div></div>
        <div class="row"><div class="label">Lever du soleil</div><div class="value" id="sunrise">‚Äî</div></div>
        <div class="row"><div class="label">Coucher du soleil</div><div class="value" id="sunset">‚Äî</div></div>
      </div>
    </div>
  </div>

  <script>
    const els = {
      cityInput: document.getElementById("cityInput"),
      searchBtn: document.getElementById("searchBtn"),
      geoBtn: document.getElementById("geoBtn"),

      cityName: document.getElementById("cityName"),
      country: document.getElementById("country"),
      timeLocal: document.getElementById("timeLocal"),
      desc: document.getElementById("desc"),
      temp: document.getElementById("temp"),
      feels: document.getElementById("feels"),
      chips: document.getElementById("chips"),
      status: document.getElementById("status"),

      humidity: document.getElementById("humidity"),
      wind: document.getElementById("wind"),
      pressure: document.getElementById("pressure"),
      visibility: document.getElementById("visibility"),
      sunrise: document.getElementById("sunrise"),
      sunset: document.getElementById("sunset"),

      fxClouds: document.getElementById("fxClouds"),
      fxRain: document.getElementById("fxRain"),
      fxSnow: document.getElementById("fxSnow"),
      fxStorm: document.getElementById("fxStorm"),
      fxSun: document.getElementById("fxSun"),
    };

    function setStatus(msg, isError=false){
      els.status.textContent = msg || "";
      els.status.classList.toggle("error", isError);
    }

    function fmtTemp(c){ return `${Math.round(c)}¬∞`; }

    function fmtTimeFromUnix(unix, tzOffsetSec){
      const date = new Date((unix + tzOffsetSec) * 1000);
      const hh = String(date.getUTCHours()).padStart(2,"0");
      const mm = String(date.getUTCMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    function fmtKm(m){ return `${(m/1000).toFixed(1)} km`; }

    function themeFromWeather(main){
      const m = (main || "").toLowerCase();
      if (m.includes("thunder")) return "storm";
      if (m.includes("snow")) return "snow";
      if (m.includes("rain") || m.includes("drizzle")) return "rain";
      if (m.includes("clear")) return "clear";
      if (m.includes("cloud")) return "clouds";
      return "clouds";
    }

    function applyTheme(theme){
      document.body.dataset.theme = theme;

      const show = (el, ok) => el.classList.toggle("hidden", !ok);

      show(els.fxClouds, theme === "clouds");
      show(els.fxSun, theme === "clear");
      show(els.fxRain, theme === "rain");
      show(els.fxSnow, theme === "snow");
      show(els.fxStorm, theme === "storm");

      if(theme === "rain") spawnRain(160);
      else els.fxRain.innerHTML = "";

      if(theme === "snow") spawnSnow(80);
      else els.fxSnow.innerHTML = "";
    }

    function spawnRain(n){
      const w = window.innerWidth;
      els.fxRain.innerHTML = "";
      for(let i=0;i<n;i++){
        const d = document.createElement("div");
        d.className = "drop";
        d.style.left = (Math.random()*w) + "px";
        d.style.animationDuration = (0.8 + Math.random()*0.9) + "s";
        d.style.animationDelay = (-(Math.random()*1.6)) + "s";
        d.style.opacity = (0.35 + Math.random()*0.55);
        d.style.height = (12 + Math.random()*22) + "px";
        els.fxRain.appendChild(d);
      }
    }

    function spawnSnow(n){
      const w = window.innerWidth;
      els.fxSnow.innerHTML = "";
      for(let i=0;i<n;i++){
        const f = document.createElement("div");
        f.className = "flake";
        f.style.left = (Math.random()*w) + "px";
        f.style.animationDuration = (4.5 + Math.random()*5.5) + "s";
        f.style.animationDelay = (-(Math.random()*3)) + "s";
        const size = 3 + Math.random()*6;
        f.style.width = size + "px";
        f.style.height = size + "px";
        f.style.opacity = (0.35 + Math.random()*0.6);
        els.fxSnow.appendChild(f);
      }
    }

    function renderChips(data){
      const chips = [];
      const { main, wind, clouds } = data;

      if(clouds && typeof clouds.all === "number") chips.push({label:"Nuages", value:`${clouds.all}%`});
      if(wind && typeof wind.speed === "number") chips.push({label:"Vent", value:`${Math.round(wind.speed)} m/s`});
      if(main && typeof main.temp_min === "number") chips.push({label:"Min", value:fmtTemp(main.temp_min)});
      if(main && typeof main.temp_max === "number") chips.push({label:"Max", value:fmtTemp(main.temp_max)});

      els.chips.innerHTML = chips.map(c => `<div class="chip">${c.label} : <b>${c.value}</b></div>`).join("");
    }

    async function callApi(params){
      const url = new URL("/api/weather", location.origin);
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));

      const res = await fetch(url.toString());
      const txt = await res.text().catch(()=> "");
      if(!res.ok) throw new Error(`${res.status} ${txt}`);
      return JSON.parse(txt);
    }

    function updateUI(data){
      const w = data.weather?.[0];
      const theme = themeFromWeather(w?.main);
      applyTheme(theme);

      els.cityName.textContent = data.name ?? "‚Äî";
      els.country.textContent = data.sys?.country ? `Pays: ${data.sys.country}` : "‚Äî";
      els.desc.textContent = w?.description ?? "‚Äî";

      els.temp.textContent = fmtTemp(data.main.temp);
      els.feels.textContent = `Ressenti ${fmtTemp(data.main.feels_like)}`;

      const tz = data.timezone ?? 0;
      const now = Math.floor(Date.now()/1000);
      els.timeLocal.textContent = `Heure locale: ${fmtTimeFromUnix(now, tz)}`;

      els.humidity.textContent = (data.main?.humidity != null) ? `${data.main.humidity}%` : "‚Äî";
      els.wind.textContent = (data.wind?.speed != null) ? `${Math.round(data.wind.speed)} m/s` : "‚Äî";
      els.pressure.textContent = (data.main?.pressure != null) ? `${data.main.pressure} hPa` : "‚Äî";
      els.visibility.textContent = (data.visibility != null) ? fmtKm(data.visibility) : "‚Äî";

      els.sunrise.textContent = data.sys?.sunrise ? fmtTimeFromUnix(data.sys.sunrise, tz) : "‚Äî";
      els.sunset.textContent = data.sys?.sunset ? fmtTimeFromUnix(data.sys.sunset, tz) : "‚Äî";

      renderChips(data);
    }

    async function searchCity(){
      const city = els.cityInput.value.trim();
      if(!city) return setStatus("Entre une ville üôÇ", true);

      setStatus("Chargement‚Ä¶");
      try{
        const data = await callApi({ q: city });
        updateUI(data);
        setStatus("");
      }catch(e){
        console.error(e);
        setStatus("Erreur: " + (e.message || "ville introuvable"), true);
      }
    }

    function useGeolocation(){
      if(!navigator.geolocation){
        return setStatus("G√©olocalisation non support√©e par ton navigateur.", true);
      }

      setStatus("Localisation‚Ä¶");
      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          try{
            setStatus("Chargement‚Ä¶");
            const data = await callApi({
              lat: String(pos.coords.latitude),
              lon: String(pos.coords.longitude),
            });
            updateUI(data);
            setStatus("");
          }catch(e){
            console.error(e);
            setStatus("Erreur OpenWeather: " + (e.message || "inconnue"), true);
          }
        },
        (err) => {
          console.error(err);
          let msg = "G√©olocalisation: erreur inconnue.";
          if(err.code === 1) msg = "G√©olocalisation refus√©e (permission).";
          if(err.code === 2) msg = "Position indisponible.";
          if(err.code === 3) msg = "Timeout g√©olocalisation.";
          setStatus(msg, true);
        },
        { enableHighAccuracy:false, timeout: 12000, maximumAge: 60000 }
      );
    }

    els.searchBtn.addEventListener("click", searchCity);
    els.cityInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") searchCity(); });
    els.geoBtn.addEventListener("click", useGeolocation);

    window.addEventListener("resize", ()=>{
      const theme = document.body.dataset.theme;
      if(theme === "rain") spawnRain(160);
      if(theme === "snow") spawnSnow(80);
    });

    (function boot(){
      els.cityInput.value = "Paris";
      applyTheme("clouds");
      setStatus("Pr√™t üôÇ Recherche une ville, ou clique sur üìç.");
    })();
  </script>
</body>
</html>
