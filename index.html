<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather Dashboard</title>
  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(900px 650px at 80% 45%, rgba(120,200,255,.10), transparent 60%),
                  linear-gradient(180deg, #0b1220, #070a12);
    }
    .wrap{
      width:min(1200px, 96vw);
      margin:22px auto;
      display:grid;
      grid-template-columns: 88px 1fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
    }

    .glass{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    /* Sidebar */
    .sidebar{
      padding:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
    }
    .logo{
      width:48px;height:48px;border-radius:14px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      display:grid;place-items:center;
      font-weight:900;
    }
    .sbtn{
      width:48px;height:48px;border-radius:16px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      display:grid;place-items:center;
      cursor:pointer;
      transition:.15s;
      user-select:none;
    }
    .sbtn:hover{ background: rgba(255,255,255,.12); transform: translateY(-1px); }
    .spacer{ flex:1; }

    /* Main layout */
    .main{
      padding:16px;
      display:grid;
      gap:16px;
      grid-template-columns: 1.1fr .9fr;
      grid-template-rows: auto auto;
      grid-template-areas:
        "top top"
        "left right";
    }
    @media (max-width: 980px){
      .main{
        grid-template-columns: 1fr;
        grid-template-areas:
          "top"
          "left"
          "right";
      }
    }

    .topbar{ grid-area: top; padding:14px; display:flex; gap:12px; align-items:center; }
    .search{ flex:1; display:flex; gap:10px; }
    input{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--text);
      border-radius: 14px;
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color:rgba(255,255,255,.55); }
    button{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 14px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:650;
      transition: .15s;
      white-space:nowrap;
    }
    button:hover{ background: rgba(255,255,255,.14); transform: translateY(-1px); }
    button:active{ transform: translateY(0px) scale(.99); }
    .pill{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      color: rgba(255,255,255,.85);
      font-size:13px;
      white-space:nowrap;
    }

    .left{ grid-area:left; padding:14px; display:grid; gap:14px; }
    .right{ grid-area:right; padding:14px; display:grid; gap:14px; }

    /* Current */
    .current{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      padding:14px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.12);
    }
    .city{ font-size:22px; font-weight:900; line-height:1.1; }
    .meta{ margin-top:6px; color:var(--muted); font-size:13px; display:flex; gap:10px; flex-wrap:wrap; }
    .desc{ margin-top:6px; color:rgba(255,255,255,.80); text-transform:capitalize; }
    .temp{ font-size:54px; font-weight:1000; letter-spacing:-1px; }
    .sub{ margin-top:6px; color:var(--muted); font-size:13px; text-align:right; }

    /* Stats */
    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      .stats{ grid-template-columns: 1fr 1fr; }
    }
    .stat{
      padding:12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.10);
    }
    .stat .k{ color:var(--muted); font-size:12px; }
    .stat .v{ font-weight:900; font-size:18px; margin-top:6px; }

    /* Favorites */
    .favBox{
      padding:14px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.10);
    }
    .favHead{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .favList{ margin-top:10px; display:grid; gap:8px; }
    .favItem{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
    }
    .favItem:hover{ background: rgba(255,255,255,.10); }
    .favName{ font-weight:800; }
    .favMini{ color:var(--muted); font-size:12px; }
    .xbtn{
      border:none;
      background: transparent;
      cursor:pointer;
      color: rgba(255,255,255,.8);
      font-size:16px;
      padding:6px 8px;
      border-radius: 10px;
    }
    .xbtn:hover{ background: rgba(255,255,255,.12); }

    /* 7 days */
    .daysGrid{
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap:10px;
      overflow:auto;
      padding-bottom:6px;
    }
    .day{
      min-width: 120px;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
    }
    .day .d{ color:rgba(255,255,255,.85); font-weight:900; font-size:13px; }
    .day .m{ color:var(--muted); font-size:12px; margin-top:4px; text-transform:capitalize;}
    .day .t{ display:flex; justify-content:space-between; margin-top:10px; font-weight:900; }
    .badge{
      display:inline-block;
      margin-top:10px;
      font-size:12px;
      padding:6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.85);
    }

    /* Chart */
    .chartBox{
      padding:14px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.10);
    }
    .chartHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .chartHead .title{ font-weight:900; }
    canvas{
      width:100%;
      height:240px;
      display:block;
    }

    .status{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      color: rgba(255,255,255,.85);
      font-size:13px;
    }
    .error{ color: rgba(255,180,180,.95); }
  </style>
</head>

<body>
  <div class="wrap">
    <aside class="sidebar glass">
      <div class="logo">‚òÅÔ∏è</div>
      <div class="sbtn" title="Dashboard">üè†</div>
      <div class="sbtn" title="Favoris">‚≠ê</div>
      <div class="sbtn" title="Graph">üìà</div>
      <div class="spacer"></div>
      <div class="sbtn" title="Settings">‚öôÔ∏è</div>
    </aside>

    <main class="main glass">
      <div class="topbar glass">
        <div class="search">
          <input id="cityInput" placeholder="Rechercher une ville (ex: Paris, Montr√©al‚Ä¶)" autocomplete="off" />
          <button id="searchBtn">Rechercher</button>
          <button id="geoBtn" title="Utiliser ma position">üìç</button>
        </div>
        <div class="pill" id="pillLocal">‚Äî</div>
        <button id="favBtn" title="Ajouter aux favoris">‚≠ê Favori</button>
      </div>

      <section class="left">
        <div class="current">
          <div>
            <div class="city" id="cityName">‚Äî</div>
            <div class="meta" id="metaLine">‚Äî</div>
            <div class="desc" id="desc">‚Äî</div>
          </div>
          <div style="text-align:right">
            <div class="temp" id="temp">--¬∞</div>
            <div class="sub" id="feels">Ressenti ‚Äî</div>
          </div>
        </div>

        <div class="stats">
          <div class="stat"><div class="k">Humidit√©</div><div class="v" id="humidity">‚Äî</div></div>
          <div class="stat"><div class="k">Vent</div><div class="v" id="wind">‚Äî</div></div>
          <div class="stat"><div class="k">Pression</div><div class="v" id="pressure">‚Äî</div></div>
          <div class="stat"><div class="k">Visibilit√©</div><div class="v" id="visibility">‚Äî</div></div>
          <div class="stat"><div class="k">Lever</div><div class="v" id="sunrise">‚Äî</div></div>
          <div class="stat"><div class="k">Coucher</div><div class="v" id="sunset">‚Äî</div></div>
        </div>

        <div class="chartBox">
          <div class="chartHead">
            <div class="title">Temp√©rature (prochaines heures)</div>
            <div class="pill" id="chartHint">‚Äî</div>
          </div>
          <canvas id="tempChart" width="900" height="300"></canvas>
        </div>

        <div class="status" id="status">Pr√™t üôÇ</div>
      </section>

      <section class="right">
        <div class="favBox">
          <div class="favHead">
            <div style="font-weight:900">Favoris</div>
            <div class="pill" id="favCount">0</div>
          </div>
          <div class="favList" id="favList"></div>
        </div>

        <div class="favBox">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div style="font-weight:900">7 prochains jours</div>
            <div class="pill" id="daysHint">‚Äî</div>
          </div>
          <div style="margin-top:10px" class="daysGrid" id="daysGrid"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // -----------------------------
    // Helpers
    // -----------------------------
    const $ = (id) => document.getElementById(id);

    const els = {
      cityInput: $("cityInput"),
      searchBtn: $("searchBtn"),
      geoBtn: $("geoBtn"),
      favBtn: $("favBtn"),

      cityName: $("cityName"),
      metaLine: $("metaLine"),
      desc: $("desc"),
      temp: $("temp"),
      feels: $("feels"),
      pillLocal: $("pillLocal"),

      humidity: $("humidity"),
      wind: $("wind"),
      pressure: $("pressure"),
      visibility: $("visibility"),
      sunrise: $("sunrise"),
      sunset: $("sunset"),

      status: $("status"),

      favList: $("favList"),
      favCount: $("favCount"),

      daysGrid: $("daysGrid"),
      daysHint: $("daysHint"),

      chart: $("tempChart"),
      chartHint: $("chartHint"),
    };

    const LS_KEY = "weather_favs_v1";

    function setStatus(msg, isError=false){
      els.status.textContent = msg || "";
      els.status.classList.toggle("error", isError);
    }

    function fmtTemp(c){ return `${Math.round(c)}¬∞`; }

    function fmtKm(m){ return `${(m/1000).toFixed(1)} km`; }

    function fmtTimeFromUnix(unix, tzOffsetSec){
      const date = new Date((unix + tzOffsetSec) * 1000);
      const hh = String(date.getUTCHours()).padStart(2,"0");
      const mm = String(date.getUTCMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    function fmtDayLabel(unix, tzOffsetSec){
      const d = new Date((unix + tzOffsetSec) * 1000);
      const day = d.toLocaleDateString("fr-FR", { weekday:"short" });
      const dd = d.toLocaleDateString("fr-FR", { day:"2-digit", month:"short" });
      return { day, dd };
    }

    async function callApi(path, params){
      const url = new URL(path, location.origin);
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
      const res = await fetch(url.toString());
      const txt = await res.text().catch(()=> "");
      if(!res.ok) throw new Error(`${res.status} ${txt}`);
      return JSON.parse(txt);
    }

    // -----------------------------
    // Favorites
    // -----------------------------
    function loadFavs(){
      try{
        return JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      }catch{
        return [];
      }
    }

    function saveFavs(list){
      localStorage.setItem(LS_KEY, JSON.stringify(list));
    }

    function renderFavs(activeKey=null){
      const favs = loadFavs();
      els.favCount.textContent = String(favs.length);
      els.favList.innerHTML = "";

      if(!favs.length){
        els.favList.innerHTML = `<div style="color:rgba(255,255,255,.65);font-size:13px;padding:10px">
          Aucun favori. Cherche une ville puis clique ‚≠ê.
        </div>`;
        return;
      }

      favs.forEach((f) => {
        const item = document.createElement("div");
        item.className = "favItem";
        item.innerHTML = `
          <div>
            <div class="favName">${f.name}</div>
            <div class="favMini">${f.country} ‚Ä¢ ${f.lat.toFixed(2)}, ${f.lon.toFixed(2)}</div>
          </div>
          <button class="xbtn" title="Supprimer">‚úï</button>
        `;

        // click to load
        item.addEventListener("click", (e) => {
          if(e.target.closest(".xbtn")) return;
          loadByCoords(f.lat, f.lon);
        });

        // delete
        item.querySelector(".xbtn").addEventListener("click", (e) => {
          e.stopPropagation();
          const next = loadFavs().filter(x => x.key !== f.key);
          saveFavs(next);
          renderFavs(activeKey);
        });

        if(activeKey && f.key === activeKey){
          item.style.outline = "2px solid rgba(255,255,255,.22)";
        }

        els.favList.appendChild(item);
      });
    }

    function addCurrentToFav(){
      if(!STATE.current) return;
      const c = STATE.current;
      const key = `${c.name}|${c.sys?.country}|${c.coord.lat.toFixed(4)}|${c.coord.lon.toFixed(4)}`;

      const favs = loadFavs();
      if(favs.some(f => f.key === key)){
        setStatus("D√©j√† dans les favoris ‚≠ê");
        return;
      }
      favs.unshift({
        key,
        name: c.name,
        country: c.sys?.country || "‚Äî",
        lat: c.coord.lat,
        lon: c.coord.lon,
      });
      saveFavs(favs);
      renderFavs(key);
      setStatus("Ajout√© aux favoris ‚≠ê");
    }

    // -----------------------------
    // State + UI
    // -----------------------------
    const STATE = {
      current: null,
      onecall: null,
    };

    function updateCurrentUI(data){
      STATE.current = data;

      const w = data.weather?.[0];
      const tz = data.timezone ?? 0;

      const now = Math.floor(Date.now()/1000);
      const localTime = fmtTimeFromUnix(now, tz);

      els.cityName.textContent = data.name ?? "‚Äî";
      els.desc.textContent = w?.description ?? "‚Äî";
      els.temp.textContent = fmtTemp(data.main?.temp ?? 0);
      els.feels.textContent = `Ressenti ${fmtTemp(data.main?.feels_like ?? 0)}`;

      els.metaLine.textContent =
        `${data.sys?.country ?? "‚Äî"} ‚Ä¢ Heure locale ${localTime}`;

      els.pillLocal.textContent = `üïí ${localTime}`;

      els.humidity.textContent = (data.main?.humidity != null) ? `${data.main.humidity}%` : "‚Äî";
      els.wind.textContent = (data.wind?.speed != null) ? `${Math.round(data.wind.speed)} m/s` : "‚Äî";
      els.pressure.textContent = (data.main?.pressure != null) ? `${data.main.pressure} hPa` : "‚Äî";
      els.visibility.textContent = (data.visibility != null) ? fmtKm(data.visibility) : "‚Äî";

      els.sunrise.textContent = data.sys?.sunrise ? fmtTimeFromUnix(data.sys.sunrise, tz) : "‚Äî";
      els.sunset.textContent = data.sys?.sunset ? fmtTimeFromUnix(data.sys.sunset, tz) : "‚Äî";
    }

    function render7Days(onecall){
      // onecall.daily : 8 jours (souvent), on prend 7 prochains (sans today si tu veux)
      const daily = onecall.daily || [];
      const tz = onecall.timezone_offset ?? 0;

      els.daysGrid.innerHTML = "";

      if(!daily.length){
        els.daysGrid.innerHTML = `<div style="color:rgba(255,255,255,.65);font-size:13px;padding:10px">
          Pas de donn√©es ‚Äúdaily‚Äù. (Si One Call n‚Äôest pas dispo sur ton plan, dis-moi et je te mets Open-Meteo.)
        </div>`;
        return;
      }

      const slice = daily.slice(1, 8); // demain -> J+7
      els.daysHint.textContent = `${slice.length} jours`;

      slice.forEach(d => {
        const { day, dd } = fmtDayLabel(d.dt, tz);
        const el = document.createElement("div");
        el.className = "day";
        el.innerHTML = `
          <div class="d">${day}</div>
          <div class="m">${dd}</div>
          <div class="t">
            <span>${fmtTemp(d.temp?.min ?? 0)}</span>
            <span>${fmtTemp(d.temp?.max ?? 0)}</span>
          </div>
          <div class="badge">${(d.weather?.[0]?.description ?? "‚Äî")}</div>
        `;
        els.daysGrid.appendChild(el);
      });
    }

    // -----------------------------
    // Simple canvas line chart (no lib)
    // -----------------------------
    function drawTempChart(onecall){
      const hourly = (onecall.hourly || []).slice(0, 24); // 24 prochaines heures
      const tz = onecall.timezone_offset ?? 0;

      const canvas = els.chart;
      const ctx = canvas.getContext("2d");

      // retina
      const dpr = window.devicePixelRatio || 1;
      const cssW = canvas.clientWidth || 900;
      const cssH = 240;
      canvas.style.height = cssH + "px";
      canvas.width = Math.floor(cssW * dpr);
      canvas.height = Math.floor(cssH * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);

      ctx.clearRect(0,0,cssW,cssH);

      if(!hourly.length){
        ctx.fillStyle = "rgba(255,255,255,.7)";
        ctx.font = "14px system-ui";
        ctx.fillText("Pas de donn√©es ‚Äúhourly‚Äù.", 14, 28);
        return;
      }

      const temps = hourly.map(h => h.temp);
      const minT = Math.min(...temps);
      const maxT = Math.max(...temps);

      const pad = 18;
      const W = cssW, H = cssH;
      const x0 = pad, y0 = pad, x1 = W-pad, y1 = H-pad;

      // grid lines
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 1;
      for(let i=0;i<=4;i++){
        const y = y0 + (i*(y1-y0)/4);
        ctx.beginPath();
        ctx.moveTo(x0, y);
        ctx.lineTo(x1, y);
        ctx.stroke();
      }

      // map function
      const xFor = (i) => x0 + (i*(x1-x0)/(hourly.length-1));
      const yFor = (t) => {
        const n = (t - minT) / ((maxT - minT) || 1);
        return y1 - n*(y1-y0);
      };

      // line
      ctx.strokeStyle = "rgba(120,200,255,.9)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      hourly.forEach((h,i) => {
        const x = xFor(i);
        const y = yFor(h.temp);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // points
      ctx.fillStyle = "rgba(255,255,255,.9)";
      hourly.forEach((h,i) => {
        const x = xFor(i);
        const y = yFor(h.temp);
        ctx.beginPath();
        ctx.arc(x,y,3,0,Math.PI*2);
        ctx.fill();
      });

      // labels (every 6 hours)
      ctx.fillStyle = "rgba(255,255,255,.75)";
      ctx.font = "12px system-ui";
      for(let i=0;i<hourly.length;i+=6){
        const h = hourly[i];
        const hour = fmtTimeFromUnix(h.dt, tz);
        const x = xFor(i);
        ctx.fillText(hour, Math.max(6, x-14), H-8);
      }

      els.chartHint.textContent = `Min ${fmtTemp(minT)} ‚Ä¢ Max ${fmtTemp(maxT)}`;
    }

    // -----------------------------
    // Load flows
    // -----------------------------
    async function loadByCity(city){
      setStatus("Chargement‚Ä¶");
      try{
        const current = await callApi("/api/weather", { q: city });
        updateCurrentUI(current);

        // One Call needs coords
        const lat = current.coord?.lat;
        const lon = current.coord?.lon;

        const onecall = await callApi("/api/onecall", { lat: String(lat), lon: String(lon) });
        STATE.onecall = onecall;

        render7Days(onecall);
        drawTempChart(onecall);

        renderFavs();
        setStatus("");
      }catch(e){
        console.error(e);
        setStatus("Erreur: " + (e.message || "inconnue"), true);
      }
    }

    async function loadByCoords(lat, lon){
      setStatus("Chargement‚Ä¶");
      try{
        const current = await callApi("/api/weather", { lat: String(lat), lon: String(lon) });
        updateCurrentUI(current);

        const onecall = await callApi("/api/onecall", { lat: String(lat), lon: String(lon) });
        STATE.onecall = onecall;

        render7Days(onecall);
        drawTempChart(onecall);

        renderFavs(`${current.name}|${current.sys?.country}|${lat.toFixed(4)}|${lon.toFixed(4)}`);
        setStatus("");
      }catch(e){
        console.error(e);
        setStatus("Erreur: " + (e.message || "inconnue"), true);
      }
    }

    function useGeolocation(){
      if(!navigator.geolocation){
        return setStatus("G√©olocalisation non support√©e.", true);
      }

      setStatus("Localisation‚Ä¶");
      navigator.geolocation.getCurrentPosition(
        (pos) => loadByCoords(pos.coords.latitude, pos.coords.longitude),
        (err) => {
          console.error(err);
          let msg = "G√©olocalisation: erreur.";
          if(err.code === 1) msg = "G√©olocalisation refus√©e (permission).";
          if(err.code === 2) msg = "Position indisponible.";
          if(err.code === 3) msg = "Timeout g√©olocalisation.";
          setStatus(msg, true);
        },
        { enableHighAccuracy:false, timeout: 12000, maximumAge: 60000 }
      );
    }

    // -----------------------------
    // Events
    // -----------------------------
    els.searchBtn.addEventListener("click", () => loadByCity(els.cityInput.value.trim()));
    els.cityInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter") loadByCity(els.cityInput.value.trim());
    });
    els.geoBtn.addEventListener("click", useGeolocation);
    els.favBtn.addEventListener("click", addCurrentToFav);

    window.addEventListener("resize", () => {
      if(STATE.onecall) drawTempChart(STATE.onecall);
    });

    // boot
    renderFavs();
    els.cityInput.value = "Paris";
    loadByCity("Paris");
  </script>
</body>
</html>
