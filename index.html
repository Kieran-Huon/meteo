<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather Dashboard</title>

  <!-- Leaflet (page Carte) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(900px 650px at 80% 45%, rgba(120,200,255,.10), transparent 60%),
                  linear-gradient(180deg, #0b1220, #070a12);
    }
    .wrap{
      width:min(1200px, 96vw);
      margin:22px auto;
      display:grid;
      grid-template-columns: 88px 1fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
    }

    .glass{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    /* Sidebar */
    .sidebar{
      padding:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
    }
    .logo{
      width:48px;height:48px;border-radius:14px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      display:grid;place-items:center;
      font-weight:900;
    }
    .sbtn{
      width:48px;height:48px;border-radius:16px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      display:grid;place-items:center;
      cursor:pointer;
      transition:.15s;
      user-select:none;
    }
    .sbtn:hover{ background: rgba(255,255,255,.12); transform: translateY(-1px); }
    .sbtn.active{
      outline: 2px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.12);
    }
    .spacer{ flex:1; }

    /* Main layout shell */
    .main{
      padding:16px;
      display:grid;
      gap:16px;
    }

    /* Topbar */
    .topbar{ padding:14px; display:flex; gap:12px; align-items:center; }
    .search{ flex:1; display:flex; gap:10px; }
    input{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--text);
      border-radius: 14px;
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color:rgba(255,255,255,.55); }
    button{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 14px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:650;
      transition: .15s;
      white-space:nowrap;
    }
    button:hover{ background: rgba(255,255,255,.14); transform: translateY(-1px); }
    button:active{ transform: translateY(0px) scale(.99); }
    .pill{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      color: rgba(255,255,255,.85);
      font-size:13px;
      white-space:nowrap;
      display:flex; align-items:center; gap:8px;
    }

    /* Pages */
    .page{ display:none; }
    .page.active{ display:block; }

    /* Dashboard grid (page 1) */
    .dash{
      display:grid;
      gap:16px;
      grid-template-columns: 1.1fr .9fr;
      grid-template-areas: "left right";
    }
    @media (max-width: 980px){
      .dash{ grid-template-columns: 1fr; grid-template-areas: "left" "right"; }
    }
    .left{ grid-area:left; padding:14px; display:grid; gap:14px; }
    .right{ grid-area:right; padding:14px; display:grid; gap:14px; }

    /* Current */
    .current{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      padding:14px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.12);
    }
    .cityLine{ display:flex; align-items:center; gap:10px; }
    .city{ font-size:22px; font-weight:900; line-height:1.1; }
    .wxEmoji{
      width:38px; height:38px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      font-size:20px;
    }
    .meta{ margin-top:6px; color:var(--muted); font-size:13px; display:flex; gap:10px; flex-wrap:wrap; }
    .desc{ margin-top:6px; color:rgba(255,255,255,.80); text-transform:capitalize; }
    .temp{ font-size:54px; font-weight:1000; letter-spacing:-1px; }
    .sub{ margin-top:6px; color:var(--muted); font-size:13px; text-align:right; }

    /* Stats */
    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      .stats{ grid-template-columns: 1fr 1fr; }
    }
    .stat{
      padding:12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.10);
    }
    .stat .k{ color:var(--muted); font-size:12px; }
    .stat .v{ font-weight:900; font-size:18px; margin-top:6px; }

    /* Favorites */
    .favBox{
      padding:14px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.10);
    }
    .favHead{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .favList{ margin-top:10px; display:grid; gap:8px; }
    .favItem{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
    }
    .favItem:hover{ background: rgba(255,255,255,.10); }
    .favName{ font-weight:800; }
    .favMini{ color:var(--muted); font-size:12px; }
    .xbtn{
      border:none;
      background: transparent;
      cursor:pointer;
      color: rgba(255,255,255,.8);
      font-size:16px;
      padding:6px 8px;
      border-radius: 10px;
    }
    .xbtn:hover{ background: rgba(255,255,255,.12); }

    /* Chart */
    .chartBox{
      position:relative;
      padding:14px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.10);
    }
    .chartHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .chartHead .title{ font-weight:900; }
    canvas{
      width:100%;
      height:300px; /* graph bigger */
      display:block;
    }
    .tooltip{
      position:absolute;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      color: rgba(255,255,255,.92);
      font-size:12px;
      pointer-events:none;
      transform: translate(-50%, -120%);
      white-space:nowrap;
    }
    .tooltip.hidden{ display:none; }

    /* 7 days: compact + slider */
    .daysBox{
      padding:14px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.10);
      display:grid;
      gap:10px;
    }
    .daysHeader{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .daysHeader .title{ font-weight:900; }

    .daysViewport{
      display:flex;
      align-items:stretch;
      gap:10px;
    }
    .navBtn{
      width:42px;
      border-radius: 14px;
      padding:10px 0;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .navBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .daysTrack{
      flex:1;
      display:flex;
      gap:10px;
      overflow-x:auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      padding-bottom:6px;
      scrollbar-width: thin;
    }
    .daysTrack::-webkit-scrollbar{ height: 8px; }
    .daysTrack::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.14);
      border-radius: 999px;
    }
    .day{
      scroll-snap-align: start;
      flex: 0 0 30%;     /* ~3 cards visible */
      min-width: 190px;  /* safety */
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
    }
    @media (max-width: 980px){
      .day{ flex-basis: 70%; min-width: 240px; } /* on mobile swipe 1 by 1-ish */
    }

    .dayTop{
      display:flex; justify-content:space-between; align-items:baseline;
      margin-bottom:10px;
    }
    .day .d{ font-weight:900; font-size:13px; text-transform:capitalize; }
    .day .m{ color:var(--muted); font-size:12px; }
    .dayMid{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .dayEmoji{
      width:42px; height:42px; border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      font-size:22px;
      flex:0 0 auto;
    }
    .dayTemp{
      text-align:right;
      flex:1;
    }
    .dayTemp .avg{
      font-size:18px;
      font-weight:1000;
      letter-spacing:-.3px;
      line-height:1;
    }
    .dayTemp .mm{
      margin-top:6px;
      color: rgba(255,255,255,.75);
      font-size:12px;
    }

    .status{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      color: rgba(255,255,255,.85);
      font-size:13px;
    }
    .error{ color: rgba(255,180,180,.95); }

    /* Map page */
    .mapGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .mapGrid{ grid-template-columns: 1fr; }
    }
    .mapBox{ padding:14px; }
    #map{
      height: 520px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }
    .mapInfo{ padding:14px; display:grid; gap:14px; }
    .miniCard{
      padding:14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
    }
    .miniTitle{ font-weight:900; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
    .hintLine{ color: var(--muted); font-size:13px; line-height:1.45; }
  </style>
</head>

<body>
  <div class="wrap">
    <aside class="sidebar glass">
      <div class="logo">‚òÅÔ∏è</div>

      <div class="sbtn active" data-page="dashboard" title="Dashboard">üè†</div>
      <div class="sbtn" data-page="map" title="Carte">üó∫Ô∏è</div>

      <div class="sbtn" data-page="favorites" title="Favoris (bient√¥t)">‚≠ê</div>
      <div class="sbtn" data-page="charts" title="Graph (bient√¥t)">üìà</div>
      <div class="spacer"></div>
      <div class="sbtn" data-page="settings" title="Settings (bient√¥t)">‚öôÔ∏è</div>
    </aside>

    <main class="main glass">
      <div class="topbar glass">
        <div class="search">
          <input id="cityInput" placeholder="Rechercher une ville (ex: Paris, Montr√©al‚Ä¶)" autocomplete="off" />
          <button id="searchBtn">Rechercher</button>
          <button id="geoBtn" title="Utiliser ma position">üìç</button>
        </div>
        <div class="pill" id="pillLocal">‚Äî</div>
        <button id="favBtn" title="Ajouter aux favoris">‚≠ê Favori</button>
      </div>

      <!-- PAGE: DASHBOARD -->
      <section class="page active" id="page-dashboard">
        <div class="dash">
          <section class="left">
            <div class="current">
              <div>
                <div class="cityLine">
                  <div class="wxEmoji" id="currentEmoji">‚õÖ</div>
                  <div class="city" id="cityName">‚Äî</div>
                </div>
                <div class="meta" id="metaLine">‚Äî</div>
                <div class="desc" id="desc">‚Äî</div>
              </div>
              <div style="text-align:right">
                <div class="temp" id="temp">--¬∞</div>
                <div class="sub" id="feels">Ressenti ‚Äî</div>
              </div>
            </div>

            <div class="stats">
              <div class="stat"><div class="k">Humidit√©</div><div class="v" id="humidity">‚Äî</div></div>
              <div class="stat"><div class="k">Vent</div><div class="v" id="wind">‚Äî</div></div>
              <div class="stat"><div class="k">Pression</div><div class="v" id="pressure">‚Äî</div></div>
              <div class="stat"><div class="k">Visibilit√©</div><div class="v" id="visibility">‚Äî</div></div>
              <div class="stat"><div class="k">Lever</div><div class="v" id="sunrise">‚Äî</div></div>
              <div class="stat"><div class="k">Coucher</div><div class="v" id="sunset">‚Äî</div></div>
            </div>

            <div class="chartBox">
              <div class="chartHead">
                <div class="title">Temp√©rature (prochaines heures)</div>
                <div class="pill" id="chartHint">‚Äî</div>
              </div>
              <canvas id="tempChart" width="900" height="300"></canvas>
              <div id="chartTooltip" class="tooltip hidden"></div>
            </div>

            <div class="status" id="status">Pr√™t üôÇ</div>
          </section>

          <section class="right">
            <div class="favBox">
              <div class="favHead">
                <div style="font-weight:900">Favoris</div>
                <div class="pill" id="favCount">0</div>
              </div>
              <div class="favList" id="favList"></div>
            </div>

            <!-- NEW compact 7 days with slider -->
            <div class="daysBox">
              <div class="daysHeader">
                <div class="title">7 prochains jours</div>
                <div class="pill" id="daysHint">‚Äî</div>
              </div>

              <div class="daysViewport">
                <button class="navBtn" id="daysPrev" title="Pr√©c√©dent">‚óÄ</button>
                <div class="daysTrack" id="daysGrid"></div>
                <button class="navBtn" id="daysNext" title="Suivant">‚ñ∂</button>
              </div>
            </div>
          </section>
        </div>
      </section>

      <!-- PAGE: MAP -->
      <section class="page" id="page-map">
        <div class="mapGrid">
          <div class="mapBox">
            <div class="miniCard" style="margin-bottom:14px">
              <div class="miniTitle">üó∫Ô∏è Carte</div>
              <div class="hintLine">
                Clique sur la carte pour afficher la m√©t√©o √† cet endroit.
                (Ou cherche une ville, puis ouvre ‚ÄúCarte‚Äù.)
              </div>
            </div>
            <div id="map" class="glass"></div>
          </div>

          <div class="mapInfo">
            <div class="miniCard">
              <div class="miniTitle">üìç S√©lection</div>
              <div class="hintLine" id="mapSelection">Aucune s√©lection pour le moment.</div>
            </div>
            <div class="miniCard">
              <div class="miniTitle">üå°Ô∏è M√©t√©o</div>
              <div class="hintLine" id="mapWeather">‚Äî</div>
            </div>
            <div class="miniCard">
              <div class="miniTitle">üìÖ Prochains jours</div>
              <div class="hintLine" id="mapDays">‚Äî</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Placeholder pages (bient√¥t) -->
      <section class="page" id="page-favorites">
        <div class="miniCard">
          <div class="miniTitle">‚≠ê Favoris</div>
          <div class="hintLine">On branchera ici une page d√©di√©e (tri, recherche, groupes‚Ä¶).</div>
        </div>
      </section>

      <section class="page" id="page-charts">
        <div class="miniCard">
          <div class="miniTitle">üìà Graphiques</div>
          <div class="hintLine">On pourra mettre d‚Äôautres courbes (pluie, vent, humidit√©‚Ä¶).</div>
        </div>
      </section>

      <section class="page" id="page-settings">
        <div class="miniCard">
          <div class="miniTitle">‚öôÔ∏è Settings</div>
          <div class="hintLine">Th√®mes, unit√©s, langue, etc.</div>
        </div>
      </section>
    </main>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // -----------------------------
    // Helpers
    // -----------------------------
    const $ = (id) => document.getElementById(id);

    const els = {
      cityInput: $("cityInput"),
      searchBtn: $("searchBtn"),
      geoBtn: $("geoBtn"),
      favBtn: $("favBtn"),
      pillLocal: $("pillLocal"),

      currentEmoji: $("currentEmoji"),
      cityName: $("cityName"),
      metaLine: $("metaLine"),
      desc: $("desc"),
      temp: $("temp"),
      feels: $("feels"),

      humidity: $("humidity"),
      wind: $("wind"),
      pressure: $("pressure"),
      visibility: $("visibility"),
      sunrise: $("sunrise"),
      sunset: $("sunset"),

      status: $("status"),

      favList: $("favList"),
      favCount: $("favCount"),

      daysGrid: $("daysGrid"),
      daysHint: $("daysHint"),
      daysPrev: $("daysPrev"),
      daysNext: $("daysNext"),

      chart: $("tempChart"),
      chartHint: $("chartHint"),
      chartTooltip: $("chartTooltip"),

      mapSelection: $("mapSelection"),
      mapWeather: $("mapWeather"),
      mapDays: $("mapDays"),
    };

    const LS_KEY = "weather_favs_v1";

    function setStatus(msg, isError=false){
      els.status.textContent = msg || "";
      els.status.classList.toggle("error", isError);
    }

    function fmtTemp(c){ return `${Math.round(c)}¬∞`; }
    function fmtKm(m){ return `${(m/1000).toFixed(1)} km`; }

    function fmtTimeFromUnix(unix, tzOffsetSec){
      const date = new Date((unix + tzOffsetSec) * 1000);
      const hh = String(date.getUTCHours()).padStart(2,"0");
      const mm = String(date.getUTCMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    async function callApi(path, params){
      const url = new URL(path, location.origin);
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
      const res = await fetch(url.toString());
      const txt = await res.text().catch(()=> "");
      if(!res.ok) throw new Error(`${res.status} ${txt}`);
      return JSON.parse(txt);
    }

    // -----------------------------
    // Emoji mapping
    // -----------------------------
    function owToEmoji(main, desc){
      const m = String(main || "").toLowerCase();
      const d = String(desc || "").toLowerCase();

      if(m.includes("thunder")) return "‚õàÔ∏è";
      if(m.includes("snow")) return "üå®Ô∏è";
      if(m.includes("rain") || m.includes("drizzle")) return "üåßÔ∏è";
      if(m.includes("cloud")) return "‚òÅÔ∏è";
      if(m.includes("clear")) return "‚òÄÔ∏è";

      if(d.includes("fog") || d.includes("brume") || d.includes("mist")) return "üå´Ô∏è";
      return "‚õÖ";
    }

    function wcToEmoji(code){
      if(code === 0) return "‚òÄÔ∏è";
      if([1,2,3].includes(code)) return "‚õÖ";
      if([45,48].includes(code)) return "üå´Ô∏è";
      if([51,53,55,56,57].includes(code)) return "üå¶Ô∏è";
      if([61,63,65,66,67].includes(code)) return "üåßÔ∏è";
      if([71,73,75,77].includes(code)) return "üå®Ô∏è";
      if([80,81,82].includes(code)) return "üå¶Ô∏è";
      if([95,96,99].includes(code)) return "‚õàÔ∏è";
      return "‚õÖ";
    }

    // -----------------------------
    // Favorites
    // -----------------------------
    function loadFavs(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
      catch{ return []; }
    }
    function saveFavs(list){
      localStorage.setItem(LS_KEY, JSON.stringify(list));
    }

    function renderFavs(activeKey=null){
      const favs = loadFavs();
      els.favCount.textContent = String(favs.length);
      els.favList.innerHTML = "";

      if(!favs.length){
        els.favList.innerHTML = `<div style="color:rgba(255,255,255,.65);font-size:13px;padding:10px">
          Aucun favori. Cherche une ville puis clique ‚≠ê.
        </div>`;
        return;
      }

      favs.forEach((f) => {
        const item = document.createElement("div");
        item.className = "favItem";
        item.innerHTML = `
          <div>
            <div class="favName">${f.name}</div>
            <div class="favMini">${f.country} ‚Ä¢ ${f.lat.toFixed(2)}, ${f.lon.toFixed(2)}</div>
          </div>
          <button class="xbtn" title="Supprimer">‚úï</button>
        `;

        item.addEventListener("click", (e) => {
          if(e.target.closest(".xbtn")) return;
          loadByCoords(f.lat, f.lon);
        });

        item.querySelector(".xbtn").addEventListener("click", (e) => {
          e.stopPropagation();
          const next = loadFavs().filter(x => x.key !== f.key);
          saveFavs(next);
          renderFavs(activeKey);
        });

        if(activeKey && f.key === activeKey){
          item.style.outline = "2px solid rgba(255,255,255,.22)";
        }

        els.favList.appendChild(item);
      });
    }

    function addCurrentToFav(){
      if(!STATE.current) return;
      const c = STATE.current;
      const key = `${c.name}|${c.sys?.country}|${c.coord.lat.toFixed(4)}|${c.coord.lon.toFixed(4)}`;

      const favs = loadFavs();
      if(favs.some(f => f.key === key)){
        setStatus("D√©j√† dans les favoris ‚≠ê");
        return;
      }
      favs.unshift({
        key,
        name: c.name,
        country: c.sys?.country || "‚Äî",
        lat: c.coord.lat,
        lon: c.coord.lon,
      });
      saveFavs(favs);
      renderFavs(key);
      setStatus("Ajout√© aux favoris ‚≠ê");
    }

    // -----------------------------
    // Open-Meteo helpers
    // -----------------------------
    function labelDay(iso){
      const d = new Date(iso);
      const day = d.toLocaleDateString("fr-FR", { weekday:"short" });
      const dd = d.toLocaleDateString("fr-FR", { day:"2-digit", month:"short" });
      return { day, dd };
    }

    // -----------------------------
    // State + live clock + days pager
    // -----------------------------
    const STATE = {
      current: null,
      forecast: null,
      tzOffsetSec: 0,
      clockTimer: null,

      chartPoints: null,

      map: null,
      mapMarker: null,

      daysStepPx: 0, // computed on first render
    };

    function startLiveClock(){
      if(STATE.clockTimer) clearInterval(STATE.clockTimer);

      const tick = () => {
        if(!STATE.current) return;
        const now = Math.floor(Date.now()/1000);
        const localTime = fmtTimeFromUnix(now, STATE.tzOffsetSec || 0);
        els.pillLocal.textContent = `üïí ${localTime}`;

        const country = STATE.current.sys?.country ?? "‚Äî";
        els.metaLine.textContent = `${country} ‚Ä¢ Heure locale ${localTime}`;
      };

      tick();
      STATE.clockTimer = setInterval(tick, 30_000);
    }

    function updateCurrentUI(data){
      STATE.current = data;
      STATE.tzOffsetSec = data.timezone ?? 0;

      const w = data.weather?.[0];
      els.currentEmoji.textContent = owToEmoji(w?.main, w?.description);

      const now = Math.floor(Date.now()/1000);
      const localTime = fmtTimeFromUnix(now, STATE.tzOffsetSec);

      els.cityName.textContent = data.name ?? "‚Äî";
      els.desc.textContent = w?.description ?? "‚Äî";
      els.temp.textContent = fmtTemp(data.main?.temp ?? 0);
      els.feels.textContent = `Ressenti ${fmtTemp(data.main?.feels_like ?? 0)}`;

      els.metaLine.textContent = `${data.sys?.country ?? "‚Äî"} ‚Ä¢ Heure locale ${localTime}`;
      els.pillLocal.textContent = `üïí ${localTime}`;

      els.humidity.textContent = (data.main?.humidity != null) ? `${data.main.humidity}%` : "‚Äî";
      els.wind.textContent = (data.wind?.speed != null) ? `${Math.round(data.wind.speed)} m/s` : "‚Äî";
      els.pressure.textContent = (data.main?.pressure != null) ? `${data.main.pressure} hPa` : "‚Äî";
      els.visibility.textContent = (data.visibility != null) ? fmtKm(data.visibility) : "‚Äî";

      els.sunrise.textContent = data.sys?.sunrise ? fmtTimeFromUnix(data.sys.sunrise, STATE.tzOffsetSec) : "‚Äî";
      els.sunset.textContent = data.sys?.sunset ? fmtTimeFromUnix(data.sys.sunset, STATE.tzOffsetSec) : "‚Äî";

      startLiveClock();
    }

    function updateDaysNavButtons(){
      const el = els.daysGrid;
      const max = el.scrollWidth - el.clientWidth;
      const x = el.scrollLeft;
      els.daysPrev.disabled = x <= 2;
      els.daysNext.disabled = x >= max - 2;
    }

    function render7Days(forecast){
      const daily = forecast.daily;
      els.daysGrid.innerHTML = "";

      if(!daily){
        els.daysGrid.innerHTML = `<div style="color:rgba(255,255,255,.65);font-size:13px;padding:10px">
          Pas de donn√©es ‚Äúdaily‚Äù.
        </div>`;
        return;
      }

      const times = daily.time || [];
      const tmin = daily.temperature_2m_min || [];
      const tmax = daily.temperature_2m_max || [];
      const wc = daily.weathercode || [];

      els.daysHint.textContent = `${times.length} jours`;

      for(let i=0;i<times.length;i++){
        const { day, dd } = labelDay(times[i]);
        const min = tmin[i];
        const max = tmax[i];
        const avg = (typeof min === "number" && typeof max === "number") ? (min + max)/2 : null;

        const el = document.createElement("div");
        el.className = "day";
        el.innerHTML = `
          <div class="dayTop">
            <div class="d">${day}</div>
            <div class="m">${dd}</div>
          </div>
          <div class="dayMid">
            <div class="dayEmoji">${wcToEmoji(wc[i])}</div>
            <div class="dayTemp">
              <div class="avg">${avg == null ? "‚Äî" : fmtTemp(avg)}</div>
              <div class="mm">${fmtTemp(min ?? 0)} ‚Ä¢ ${fmtTemp(max ?? 0)}</div>
            </div>
          </div>
        `;
        els.daysGrid.appendChild(el);
      }

      // compute "page" scroll: 3 cards at a time
      requestAnimationFrame(() => {
        const first = els.daysGrid.querySelector(".day");
        if(first){
          const style = getComputedStyle(els.daysGrid);
          const gap = parseFloat(style.columnGap || style.gap || "10") || 10;
          STATE.daysStepPx = (first.getBoundingClientRect().width + gap) * 3;
        }else{
          STATE.daysStepPx = els.daysGrid.clientWidth;
        }
        updateDaysNavButtons();
      });
    }

    // -----------------------------
    // Chart + tooltip
    // -----------------------------
    function drawTempChart(forecast){
      const h = forecast.hourly;
      const canvas = els.chart;
      const ctx = canvas.getContext("2d");

      const dpr = window.devicePixelRatio || 1;
      const cssW = canvas.clientWidth || 900;
      const cssH = 300;
      canvas.style.height = cssH + "px";
      canvas.width = Math.floor(cssW * dpr);
      canvas.height = Math.floor(cssH * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,cssW,cssH);

      if(!h || !h.time || !h.temperature_2m){
        ctx.fillStyle = "rgba(255,255,255,.7)";
        ctx.font = "14px system-ui";
        ctx.fillText("Pas de donn√©es hourly.", 14, 28);
        els.chartHint.textContent = "‚Äî";
        STATE.chartPoints = null;
        return;
      }

      const times = h.time.slice(0, 24);
      const temps = h.temperature_2m.slice(0, 24);

      if(!temps.length){
        ctx.fillStyle = "rgba(255,255,255,.7)";
        ctx.font = "14px system-ui";
        ctx.fillText("Pas de donn√©es hourly.", 14, 28);
        els.chartHint.textContent = "‚Äî";
        STATE.chartPoints = null;
        return;
      }

      const minT = Math.min(...temps);
      const maxT = Math.max(...temps);

      const padTop = 14;
      const padRight = 14;
      const padBottom = 20;
      const padLeft = 44;

      const W = cssW, H = cssH;
      const x0 = padLeft, y0 = padTop, x1 = W-padRight, y1 = H-padBottom;

      const xFor = (i) => x0 + (i*(x1-x0)/(temps.length-1));
      const yFor = (t) => {
        const n = (t - minT) / ((maxT - minT) || 1);
        return y1 - n*(y1-y0);
      };

      // grid + y labels
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 1;
      const ticks = 5;
      ctx.fillStyle = "rgba(255,255,255,.70)";
      ctx.font = "12px system-ui";
      for(let i=0;i<ticks;i++){
        const p = i/(ticks-1);
        const t = maxT - p*(maxT-minT);
        const y = y0 + p*(y1-y0);

        ctx.beginPath();
        ctx.moveTo(x0, y);
        ctx.lineTo(x1, y);
        ctx.stroke();

        ctx.fillText(`${Math.round(t)}¬∞`, 8, y + 4);
      }

      // x labels every 6h
      ctx.fillStyle = "rgba(255,255,255,.75)";
      ctx.font = "12px system-ui";
      for(let i=0;i<times.length;i+=6){
        const d = new Date(times[i]);
        const hh = String(d.getHours()).padStart(2,"0");
        ctx.fillText(`${hh}h`, Math.max(x0, xFor(i)-10), H-6);
      }

      // line
      ctx.strokeStyle = "rgba(120,200,255,.9)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      temps.forEach((t,i) => {
        const x = xFor(i);
        const y = yFor(t);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      const points = temps.map((t,i) => ({ i, t, x: xFor(i), y: yFor(t), time: times[i] }));

      ctx.fillStyle = "rgba(255,255,255,.92)";
      points.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x,p.y,3,0,Math.PI*2);
        ctx.fill();
      });

      els.chartHint.textContent = `Min ${fmtTemp(minT)} ‚Ä¢ Max ${fmtTemp(maxT)}`;
      STATE.chartPoints = points;
    }

    function showTooltip(x, y, html){
      els.chartTooltip.innerHTML = html;
      els.chartTooltip.style.left = x + "px";
      els.chartTooltip.style.top = y + "px";
      els.chartTooltip.classList.remove("hidden");
    }
    function hideTooltip(){
      els.chartTooltip.classList.add("hidden");
    }

    // -----------------------------
    // Load flows
    // -----------------------------
    async function loadByCity(city){
      const c = (city || "").trim();
      if(!c) return setStatus("Entre une ville üôÇ", true);

      setStatus("Chargement‚Ä¶");
      try{
        const current = await callApi("/api/weather", { q: c });
        updateCurrentUI(current);

        const lat = current.coord?.lat;
        const lon = current.coord?.lon;

        const forecast = await callApi("/api/forecast", { lat: String(lat), lon: String(lon) });
        STATE.forecast = forecast;

        render7Days(forecast);
        drawTempChart(forecast);

        renderFavs();
        setStatus("");

        if(STATE.map) setMapMarker(lat, lon, current.name);
      }catch(e){
        console.error(e);
        setStatus("Erreur: " + (e.message || "inconnue"), true);
      }
    }

    async function loadByCoords(lat, lon){
      setStatus("Chargement‚Ä¶");
      try{
        const current = await callApi("/api/weather", { lat: String(lat), lon: String(lon) });
        updateCurrentUI(current);

        const forecast = await callApi("/api/forecast", { lat: String(lat), lon: String(lon) });
        STATE.forecast = forecast;

        render7Days(forecast);
        drawTempChart(forecast);

        renderFavs(`${current.name}|${current.sys?.country}|${Number(lat).toFixed(4)}|${Number(lon).toFixed(4)}`);
        setStatus("");

        if(STATE.map) setMapMarker(lat, lon, current.name);
      }catch(e){
        console.error(e);
        setStatus("Erreur: " + (e.message || "inconnue"), true);
      }
    }

    function useGeolocation(){
      if(!navigator.geolocation){
        return setStatus("G√©olocalisation non support√©e.", true);
      }

      setStatus("Localisation‚Ä¶");
      navigator.geolocation.getCurrentPosition(
        (pos) => loadByCoords(pos.coords.latitude, pos.coords.longitude),
        (err) => {
          console.error(err);
          let msg = "G√©olocalisation: erreur.";
          if(err.code === 1) msg = "G√©olocalisation refus√©e (permission).";
          if(err.code === 2) msg = "Position indisponible.";
          if(err.code === 3) msg = "Timeout g√©olocalisation.";
          setStatus(msg, true);
        },
        { enableHighAccuracy:false, timeout: 12000, maximumAge: 60000 }
      );
    }

    // -----------------------------
    // Sidebar navigation (pages)
    // -----------------------------
    function setPage(name){
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      const page = document.getElementById("page-" + name);
      if(page) page.classList.add("active");

      document.querySelectorAll(".sbtn[data-page]").forEach(b => {
        b.classList.toggle("active", b.dataset.page === name);
      });

      if(name === "map") initMapOnce();
      if(name !== "map") hideTooltip();
    }

    // -----------------------------
    // Map
    // -----------------------------
    function initMapOnce(){
      if(STATE.map) {
        setTimeout(() => STATE.map.invalidateSize(), 50);
        return;
      }

      const map = L.map("map", { zoomControl: true }).setView([48.8566, 2.3522], 5);
      STATE.map = map;

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      map.on("click", async (e) => {
        const { lat, lng } = e.latlng;
        els.mapSelection.textContent = `Lat ${lat.toFixed(4)}, Lon ${lng.toFixed(4)}`;
        els.mapWeather.textContent = "Chargement‚Ä¶";
        els.mapDays.textContent = "Chargement‚Ä¶";

        try{
          const current = await callApi("/api/weather", { lat: String(lat), lon: String(lng) });
          const w = current.weather?.[0];
          const emoji = owToEmoji(w?.main, w?.description);

          const now = Math.floor(Date.now()/1000);
          const t = fmtTimeFromUnix(now, current.timezone ?? 0);

          els.mapWeather.textContent =
            `${emoji} ${current.name ?? "‚Äî"} ‚Ä¢ ${fmtTemp(current.main?.temp ?? 0)} ‚Ä¢ ${w?.description ?? "‚Äî"} ‚Ä¢ ${t}`;

          const forecast = await callApi("/api/forecast", { lat: String(lat), lon: String(lng) });
          const daily = forecast.daily || {};
          const times = (daily.time || []).slice(0, 7);
          const tmin = (daily.temperature_2m_min || []).slice(0, 7);
          const tmax = (daily.temperature_2m_max || []).slice(0, 7);
          const wc = (daily.weathercode || []).slice(0, 7);

          const line = times.map((iso, i) => {
            const { day } = labelDay(iso);
            const avg = (typeof tmin[i] === "number" && typeof tmax[i] === "number") ? (tmin[i]+tmax[i])/2 : null;
            return `${day} ${wcToEmoji(wc[i])} ${avg==null ? "‚Äî" : fmtTemp(avg)}`;
          }).join("  ‚Ä¢  ");

          els.mapDays.textContent = line || "‚Äî";

          setMapMarker(lat, lng, current.name || "S√©lection");
        }catch(err){
          console.error(err);
          els.mapWeather.textContent = "Erreur m√©t√©o.";
          els.mapDays.textContent = "‚Äî";
        }
      });

      if(STATE.current?.coord){
        setMapMarker(STATE.current.coord.lat, STATE.current.coord.lon, STATE.current.name);
        map.setView([STATE.current.coord.lat, STATE.current.coord.lon], 8);
      }

      setTimeout(() => map.invalidateSize(), 50);
    }

    function setMapMarker(lat, lon, label){
      if(!STATE.map) return;
      const pos = [lat, lon];

      if(!STATE.mapMarker){
        STATE.mapMarker = L.marker(pos).addTo(STATE.map);
      }else{
        STATE.mapMarker.setLatLng(pos);
      }
      STATE.mapMarker.bindPopup(`<b>${label || "Lieu"}</b><br>${lat.toFixed(3)}, ${lon.toFixed(3)}`).openPopup();
    }

    // -----------------------------
    // Days slider controls
    // -----------------------------
    function scrollDaysBy(dir){
      const step = STATE.daysStepPx || els.daysGrid.clientWidth;
      els.daysGrid.scrollBy({ left: dir * step, behavior: "smooth" });
    }

    els.daysPrev.addEventListener("click", () => scrollDaysBy(-1));
    els.daysNext.addEventListener("click", () => scrollDaysBy(1));

    els.daysGrid.addEventListener("scroll", () => {
      updateDaysNavButtons();
    }, { passive:true });

    // -----------------------------
    // Events
    // -----------------------------
    els.searchBtn.addEventListener("click", () => loadByCity(els.cityInput.value.trim()));
    els.cityInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter") loadByCity(els.cityInput.value.trim());
    });
    els.geoBtn.addEventListener("click", useGeolocation);
    els.favBtn.addEventListener("click", addCurrentToFav);

    document.querySelectorAll(".sbtn[data-page]").forEach(btn => {
      btn.addEventListener("click", () => setPage(btn.dataset.page));
    });

    window.addEventListener("resize", () => {
      if(STATE.forecast) drawTempChart(STATE.forecast);
      if(STATE.map) setTimeout(() => STATE.map.invalidateSize(), 50);

      // recompute days step for 3 cards
      const first = els.daysGrid.querySelector(".day");
      if(first){
        const style = getComputedStyle(els.daysGrid);
        const gap = parseFloat(style.columnGap || style.gap || "10") || 10;
        STATE.daysStepPx = (first.getBoundingClientRect().width + gap) * 3;
      }
      updateDaysNavButtons();
    });

    // chart tooltip hover
    els.chart.addEventListener("mousemove", (e) => {
      const pts = STATE.chartPoints;
      if(!pts || !pts.length) return hideTooltip();

      const rect = els.chart.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;

      let best = null;
      let bestD = Infinity;
      for(const p of pts){
        const dx = mx - p.x;
        const dy = my - p.y;
        const d = dx*dx + dy*dy;
        if(d < bestD){ bestD = d; best = p; }
      }

      const radius = 14;
      if(best && bestD <= radius*radius){
        const d = new Date(best.time);
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        showTooltip(best.x, best.y, `<b>${fmtTemp(best.t)}</b> ‚Ä¢ ${hh}:${mm}`);
      }else{
        hideTooltip();
      }
    });
    els.chart.addEventListener("mouseleave", hideTooltip);

    // boot
    renderFavs();
    els.cityInput.value = "Paris";
    loadByCity("Paris");
  </script>
</body>
</html>
